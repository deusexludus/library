import os
import pandas
import re

class Duration_Search():
    res = {}
    manual_checks = []
    tID_text = "<TR><TD><FONT SIZE=1><B>TestId</B></FONT></TD><TD COLSPAN=2><FONT SIZE=1><B>"
    duration_text = "Test Duration </FONT></TD><TD COLSPAN=3><FONT SIZE=1>"

    def walk_through_dir(self):
        for subdir, dirs, files in os.walk(input_path):
            #print('Found subdirectory: %s' % subdir)
            #print('Found folders here: %s' % dirs)
            for file in files:
                filepath = subdir + os.sep + file
                #print('checking',filepath)
                if filepath.endswith(".htm"):
                    self.build_duration_from_file(filepath)

    def build_duration_from_file(self, filepath):
        skipping = 0
        for i, line in enumerate(open(filepath)):
            for match in re.finditer(self.tID_text, line):
                if match:
                    TID_end = line.find('&',76, len(line))
                    TID = line[76:TID_end]
                    skipping = 1
                    #print(f'found TID {TID} on line {i}')
            if skipping == 6:
                assert(re.finditer(self.duration_text, line))
                end = line.find('&', 77, len(line))
                duration = line[77:end]
                skipping = 0
                #print(f'found Duration: {duration} on line {i}')
                try:
                    previous = self.res[TID]
                    if abs(int(duration) - int(previous))/int(duration) < .1: #within 10%, take higher
                        self.res[TID] = max(int(self.res[TID]), int(duration))
                    else:
                        self.manual_checks.append(TID)
                except KeyError:
                    self.res[TID] = duration
                except TypeError:
                    print('TypeError')
                except ZeroDivisionError:
                    print('zero divison, check fp, i, line {filepath} {i} {line} duration was 0 because it was skipped')
            elif skipping:
                skipping += 1
        #print('printing res:', self.res)

    def output_to_excel(self):
        # outputs to an excel file named after the root results folder
        subdir_start = input_path[::-1].find('\\')
        subdir = input_path[(len(input_path) - subdir_start):]
        new_path = output_path + subdir + '.xlsx'
        print(new_path)
        writer = pandas.ExcelWriter(new_path, engine = 'openpyxl')
        df_res = pandas.DataFrame({'TID': list(map(int, self.res.keys())), 'Duration': list(map(int, self.res.values()))})
        df_res.to_excel(writer, sheet_name = 'Durations')
        if self.manual_checks:
            df_man = pandas.DataFrame({'TID': self.manual_checks, 'Check Manually?': 'Yes'})
            df_man.to_excel(writer, sheet_name = 'Manual Checks')
        writer.save()
        writer.close()
        
        

d = Duration_Search()
input_path = r'I:\Bruce\common emb 19\Duration\ARINC_Discretes'
output_path = 'C:\\Users\\H116099\\'
d.walk_through_dir()
d.output_to_excel()
